<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ilham File Encryptor/Decryptor</title>
</head>
<body>
    <h1>Client-Side File Encryptor and Decryptor</h1>

    <h2>Encrypt Files</h2>
    <form id="encryptForm">
        <input type="file" id="encryptFiles" multiple>
        <button type="button" onclick="encryptFiles()">Encrypt Files</button>
    </form>

    <h2>Decrypt Files</h2>
    <form id="decryptForm">
        <input type="file" id="decryptFiles" multiple>
        <button type="button" onclick="decryptFiles()">Decrypt Files</button>
    </form>

    <div id="downloadLink" style="margin-top: 20px;"></div>

    <script>
        // Generate a key for encryption and decryption using Web Crypto API
        let cryptoKey;

        async function generateKey() {
            cryptoKey = await window.crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        // Convert ArrayBuffer to base64 for easier download
        function arrayBufferToBase64(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)));
        }

        // Convert base64 back to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Encrypt the files
        async function encryptFiles() {
            const files = document.getElementById('encryptFiles').files;
            if (files.length === 0) {
                alert("Please select files to encrypt.");
                return;
            }

            await generateKey();  // Generate encryption key

            for (const file of files) {
                const fileData = await file.arrayBuffer();
                const iv = window.crypto.getRandomValues(new Uint8Array(12));  // Initialization vector

                const encryptedData = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    cryptoKey,
                    fileData
                );

                const encryptedBlob = new Blob([iv, encryptedData], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(encryptedBlob);

                // Create a download link for the encrypted file
                const a = document.createElement('a');
                a.href = url;
                a.download = 'encrypted_' + file.name;
                a.textContent = 'Download encrypted_' + file.name;
                document.getElementById('downloadLink').appendChild(a);
                document.getElementById('downloadLink').appendChild(document.createElement('br'));
            }
        }

        // Decrypt the files
        async function decryptFiles() {
            const files = document.getElementById('decryptFiles').files;
            if (files.length === 0) {
                alert("Please select files to decrypt.");
                return;
            }

            for (const file of files) {
                const fileData = await file.arrayBuffer();
                const iv = new Uint8Array(fileData.slice(0, 12));  // Extract IV from the first 12 bytes
                const encryptedData = fileData.slice(12);  // Rest is encrypted data

                try {
                    const decryptedData = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv },
                        cryptoKey,
                        encryptedData
                    );

                    const decryptedBlob = new Blob([decryptedData], { type: file.type });
                    const url = window.URL.createObjectURL(decryptedBlob);

                    // Create a download link for the decrypted file
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'decrypted_' + file.name;
                    a.textContent = 'Download decrypted_' + file.name;
                    document.getElementById('downloadLink').appendChild(a);
                    document.getElementById('downloadLink').appendChild(document.createElement('br'));

                } catch (error) {
                    console.error('Decryption failed:', error);
                    alert('Decryption failed. Make sure you are using the correct encrypted file.');
                }
            }
        }
    </script>
</body>
</html>
